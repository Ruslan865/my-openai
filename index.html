<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SK-1 Lokal AI v2.2</title>
  <style>
    :root { --bg:#0f0; --fg:#000; }
    body {
      background:#000;
      color:#0f0;
      font-family: monospace;
      margin:0;
      padding:1rem;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      gap:8px;
    }
    #panel {
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
    }
    #chat {
      flex:1;
      min-width:280px;
      border:1px solid #0f0;
      padding:1rem;
      border-radius:6px;
      background:#111;
      max-height:60vh;
      overflow:auto;
    }
    #controls {
      flex:1;
      min-width:280px;
      border:1px solid #0f0;
      padding:1rem;
      border-radius:6px;
      background:#111;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .message { margin:6px 0; }
    .user { color:#6f6; }
    .bot { color:#0f0; }
    .warn { color: orange; }
    .small { font-size:0.8rem; }
    button {
      background:#0f0;
      color:#000;
      border:none;
      padding:8px 12px;
      cursor:pointer;
      border-radius:4px;
      font-weight:bold;
    }
    input, textarea {
      background:#000;
      color:#0f0;
      border:1px solid #0f0;
      padding:8px;
      border-radius:4px;
      font-family: monospace;
    }
    #status { margin-top:4px; }
  </style>
</head>
<body>
  <h1>SK-1 Lokal S√ºni ƒ∞ntellekt (v2.2)</h1>
  <div id="status" class="small"></div>
  <div id="panel">
    <div id="chat" aria-live="polite"></div>
    <div id="controls">
      <label for="input">Sual / ∆èmr:</label>
      <input id="input" placeholder="M…ôs: Salam, nec…ôs…ôn?, hava?" autocomplete="off" />
      <div style="display:flex; gap:6px;">
        <button id="askBtn">G√∂nd…ôr</button>
        <button id="backupBtn">Klonla (backup)</button>
        <button id="showMemoryBtn">Yadda≈ü g√∂st…ôr</button>
        <button id="clearBtn">Yadda≈üƒ± t…ômizl…ô</button>
      </div>
      <div class="small">
        <div>√ñyr…ônm…ôk √º√ß√ºn yeni ifad…ô yaz: bilmir…ôms…ô s…ôn cavabƒ± yazacaqsan.</div>
        <div>Sinxron: ba≈üqa tablarda da d…ôrhal yenil…ônir.</div>
      </div>
      <div id="integrity" class="small"></div>
    </div>
  </div>

  <script>
  (async () => {
    // --- t…ôhl√ºk…ôsizlik: yalnƒ±z icaz…ôli hostlarda i≈ül…ôsin (t…ônziml…ôy…ô bil…ôrs…ôn) ---
    const ALLOWED = ["localhost", "127.0.0.1", location.hostname]; // √∂z hostname-ni buraya …ôlav…ô et …ôg…ôr m…ôhdudla≈üdƒ±rmaq ist…ôs…ôn
    if (!ALLOWED.includes(location.hostname)) {
      document.body.innerHTML = "<h2 style='color:orange'>‚ùå Bu m√ºhit tam yoxlanƒ±lmayƒ±b ‚Äî i≈ül…ôm…ôy…ô davam etmir…ôm.</h2>";
      return;
    }

    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const askBtn = document.getElementById("askBtn");
    const backupBtn = document.getElementById("backupBtn");
    const showMemoryBtn = document.getElementById("showMemoryBtn");
    const clearBtn = document.getElementById("clearBtn");
    const statusEl = document.getElementById("status");
    const integrityEl = document.getElementById("integrity");

    // Yadda≈ü strukturu: { "salam": "Salam, dostum!", ... }
    let memory = JSON.parse(localStorage.getItem("sk1_memory") || "{}");

    // BroadcastChannel sinxronizasiya
    let bc;
    if ("BroadcastChannel" in window) {
      bc = new BroadcastChannel("sk1-sync");
      bc.onmessage = e => {
        if (e.data && e.data.type === "memory-update") {
          memory = e.data.memory;
          localStorage.setItem("sk1_memory", JSON.stringify(memory));
          logBot("Sinxronizasiya: yadda≈ü yenil…ôndi ba≈üqa tabdan."); 
          updateIntegrity();
        }
      };
    }

    // Helper: log
    function logUser(txt) {
      const p = document.createElement("div");
      p.className = "message user";
      p.textContent = "üë§ " + txt;
      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    }
    function logBot(txt) {
      const p = document.createElement("div");
      p.className = "message bot";
      p.textContent = "ü§ñ " + txt;
      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    }

    // Sad…ô lokal cavab sistemi
    function getResponse(query) {
      const key = query.toLowerCase().trim();
      if (memory[key]) return memory[key];
      // √ñnceden tanƒ±nmƒ±≈ü a√ßar yoxdursa m√º…ôyy…ôn sad…ô qaydalar:
      if (key.includes("nec…ôs…ôn")) return "M…ôn yax≈üƒ±yam, s…ôn nec…ôs…ôn?";
      if (key.includes("salam")) return "Salam, dostum! N…ô √∂yr…ôn…ôk bug√ºn?";
      if (key.includes("adƒ±n n…ôdir")) return "M…ôni SK-1 dey…ô √ßaƒüƒ±r. S…ôn kims…ôn?";
      if (key.includes("vaxt")) return `Hazƒ±rki vaxt: ${new Date().toLocaleTimeString()}`;
      // tamamlayƒ±cƒ± yoxlama
      return null;
    }

    // √ñyr…ônm…ô: yeni input-cavab c√ºtl√ºy√º saxla
    function learn(key, value) {
      memory[key.toLowerCase().trim()] = value.trim();
      persistMemory();
      broadcastUpdate();
      logBot(`üß† √ñyr…ôndim: "${key}" -> "${value}"`);
    }

    function persistMemory() {
      localStorage.setItem("sk1_memory", JSON.stringify(memory));
    }

    function broadcastUpdate() {
      if (bc) bc.postMessage({ type: "memory-update", memory });
    }

    // √ñz√ºn√º klonlama (backup)
    function cloneSelf() {
      const snapshot = document.documentElement.outerHTML;
      localStorage.setItem("sk1_self_clone", btoa(unescape(encodeURIComponent(snapshot))));
      logBot("üîÅ √ñz√ºn√º klonladƒ±m (backup yaradƒ±ldƒ±).");
    }

    // Tamlƒ±q / integrity: yadda≈ü hash-ƒ±
    async function sha256(str) {
      const buf = new TextEncoder().encode(str);
      const hashBuffer = await crypto.subtle.digest("SHA-256", buf);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2,"0")).join("");
    }

    let lastKnownHash = "";
    async function updateIntegrity() {
      const current = JSON.stringify(memory);
      const h = await sha256(current);
      integrityEl.textContent = `Yadda≈ü checksum: ${h}${ lastKnownHash && h !== lastKnownHash ? " ‚ö†Ô∏è d…ôyi≈üilib" : "" }`;
      if (!lastKnownHash) lastKnownHash = h;
    }

    // ƒ∞stifad…ô√ßi sual verdikd…ô i≈ül…ôy…ôn
    async function handle(inputText) {
      logUser(inputText);
      let response = getResponse(inputText);
      if (response !== null) {
        logBot(response);
      } else {
        // √∂yr…ônm…ôk t…ôklifi
        const teach = prompt(`‚Äú${inputText}‚Äù √º√ß√ºn cavabƒ±m yoxdu. M…ôn…ô n…ô cavab verm…ôliy…ôm?`);
        if (teach && teach.trim()) {
          learn(inputText, teach);
          logBot(teach);
        } else {
          logBot("He√ß n…ô √∂yr…ônilm…ôdi.");
        }
      }
      await updateIntegrity();
    }

    // Eventl…ôr
    askBtn.addEventListener("click", () => {
      const v = input.value.trim();
      if (!v) return;
      handle(v);
      input.value = "";
    });
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") askBtn.click();
    });
    backupBtn.addEventListener("click", () => cloneSelf());
    showMemoryBtn.addEventListener("click", () => {
      logBot("üìö Yadda≈ü: " + JSON.stringify(memory));
    });
    clearBtn.addEventListener("click", () => {
      if (confirm("Yadda≈üƒ± tam silm…ôk ist…ôyirs…ôn?")) {
        memory = {};
        persistMemory();
        broadcastUpdate();
        logBot("üóëÔ∏è Yadda≈ü t…ômizl…ôndi.");
        updateIntegrity();
      }
    });

    // Ba≈ülanƒüƒ±c
    function init() {
      logBot("SK-1 hazƒ±rdƒ±r. Sual ver v…ô ya m√∂vzunu √∂yr…ôt.");
      updateIntegrity();
      // avtomatik klonlama ehtiyat (ilk i≈ü…ô d√º≈ü…ônd…ô)
      if (!localStorage.getItem("sk1_self_clone")) cloneSelf();
      statusEl.textContent = `Host: ${location.hostname} | Yadda≈ü giril…ônl…ôr: ${Object.keys(memory).length}`;
      setInterval(() => {
        statusEl.textContent = `Host: ${location.hostname} | Xatƒ±rlanan: ${Object.keys(memory).length}`;
      }, 3000);
    }

    // Sync interval update status
    init();

    // Periodik tamlƒ±q yoxlamasƒ± (ist…ôy…ô g√∂r…ô)
    setInterval(() => updateIntegrity(), 5000);
  })();
  </script>
</body>
</html>
